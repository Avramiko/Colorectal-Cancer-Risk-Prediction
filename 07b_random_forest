# File: 07b_random_forest.py
import utils_06_5 as utils
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report
import joblib
import os

PROCESSED_DATA_DIR = "processed_data_manual"
MODEL_OUTPUT_DIR = "modeling_results"
os.makedirs(MODEL_OUTPUT_DIR, exist_ok=True)

model_path = os.path.join(MODEL_OUTPUT_DIR, "random_forest_model.joblib")

# --- Load Data ---
X_train, y_train, X_val, y_val, X_test, y_test = utils.load_processed_data(PROCESSED_DATA_DIR)

# --- Train Model ---
rf_model = RandomForestClassifier(
    n_estimators=200,
    max_depth=10,
    min_samples_leaf=5,
    max_features="sqrt",
    class_weight="balanced_subsample",
    random_state=42,
    n_jobs=-1
)
rf_model.fit(X_train, y_train)

joblib.dump(rf_model, model_path)

# --- Predictions (Validation) ---
y_val_pred = rf_model.predict(X_val)
y_val_pred_proba = rf_model.predict_proba(X_val)[:, 1]

# --- Evaluation ---
print("\nClassification Report:")
print(classification_report(y_val, y_val_pred))

MODEL_NAME = "Random Forest"
utils.plot_confusion_matrix_professional(y_val, y_val_pred, MODEL_NAME, MODEL_OUTPUT_DIR)
utils.plot_roc_curve(y_val, y_val_pred_proba, MODEL_NAME, MODEL_OUTPUT_DIR)
utils.plot_precision_recall_curve(y_val, y_val_pred_proba, MODEL_NAME, MODEL_OUTPUT_DIR)
